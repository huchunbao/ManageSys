{"remainingRequest":"D:\\办公\\projectwc\\前端\\ManageSys\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!D:\\办公\\projectwc\\前端\\ManageSys\\src\\views\\structure\\index.vue?vue&type=script&lang=js&","dependencies":[{"path":"D:\\办公\\projectwc\\前端\\ManageSys\\src\\views\\structure\\index.vue","mtime":1576811949891},{"path":"D:\\办公\\projectwc\\前端\\ManageSys\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"D:\\办公\\projectwc\\前端\\ManageSys\\node_modules\\babel-loader\\lib\\index.js","mtime":499162500000},{"path":"D:\\办公\\projectwc\\前端\\ManageSys\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"D:\\办公\\projectwc\\前端\\ManageSys\\node_modules\\vue-loader\\lib\\index.js","mtime":499162500000}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport { get, post, put, byDelete } from '@/api/axios'\nimport Pagination from '@/components/Pagination'\nimport Account from './components/account'\nimport Role from './components/role'\nimport TreeTransfer from './components/TreeTransfer'\nimport { mapGetters } from 'vuex'\nimport { validMobile } from '@/utils/validate'\nexport default {\n  components: { Pagination, Account, TreeTransfer, Role },\n  data() {\n    const validateMobile = (rule, value, callback) => {\n      if (value === '') {\n        callback(new Error('请输入新手机号码'))\n      } else if (!validMobile(value)) {\n        callback(new Error('手机号输入不正确!'))\n      } else {\n        callback()\n      }\n    }\n    return {\n      companyData: [],\n      selectCompanyNode: null,\n      companyDelBtn: false,\n      showCompany: false,\n      addCompanyForm: { name: '', oldName: '', principal: '', mobile: '' },\n      addCompanyRules: { name: [{ required: true, message: '请输入公司名称', trigger: 'blur' }],\n        principal: [{ required: true, message: '请输入负责人姓名', trigger: 'blur' }],\n        mobile: [{ required: true, trigger: 'blur', validator: validateMobile }]\n      },\n      addCompanyType: 0,\n      defaultProps: {\n        children: 'children',\n        label: 'companyName'\n      },\n      showAuth: false,\n      authLoading: false,\n      selectCompanyId: 0,\n      departmentData: [],\n      showDepartment: false,\n      addDepartmentForm: { name: '', oldName: '' },\n      addDepartmentRules: { name: [{ required: true, message: '请输入部门名称', trigger: 'blur' }] },\n      addDepartmentType: 0,\n      selectDepartmentNode: null,\n      userData: [],\n      showUser: false,\n      addUserType: 0,\n      addUserInfo: {\n        uid: 0,\n        type: 0,\n        cpid: '',\n        deptId: '',\n        cusName: '',\n        phone: '',\n        postName: '',\n        cusPassword: '',\n        cusPic: ''\n      },\n      total: 0,\n      userLoading: false,\n      userSearchType: 0, // 0是公司  1是部门\n      listQuery: {\n        page: 1,\n        limit: 5\n      },\n      showUserRole: false,\n      userRoleForm: {\n        id: 0,\n        index: -1,\n        showName: '',\n        roleId: 0\n      },\n      roleLoading: false,\n      roleData: [],\n      showRole: false,\n      addRoleId: 0,\n      addRoleType: 0,\n      addRoleName: ''\n    }\n  },\n  computed: {\n    ...mapGetters(['companyId'])\n  },\n  created() {\n    this.init()\n  },\n  methods: {\n    init() {\n      get('/company/' + this.companyId + '/tree', null).then(response => {\n        if (response.status === 0) {\n          this.companyData = response.data\n        }\n      })\n    },\n    companyClick: function(node, all) {\n      this.selectCompanyNode = node\n      if (all.level === 1) {\n        this.companyDelBtn = false\n      } else {\n        this.companyDelBtn = true\n      }\n      this.addCompanyForm.oldName = node.companyName\n      this.showCompanyInfo(node)\n    },\n    showCompanyInfo(data) {\n      this.selectCompanyId = data.companyId\n      this.getDepartmentInfo(data.companyId)\n      this.getRoleInfo(data.companyId)\n      this.getUserInfoByCompany(data.companyId, 1)\n    },\n    authCompany() { // 授权\n      this.showAuth = true\n    },\n    authSave() {\n      this.authLoading = true\n      this.$refs.treeTransfer.saveAuth()\n    },\n    authend() {\n      this.authLoading = false\n      this.showAuth = false\n    },\n    deleteCompany: function() { // 删除公司\n      if (this.selectCompanyNode === null) {\n        this.$message({\n          message: '请选择需要删除的公司',\n          type: 'warning',\n          duration: 3000\n        })\n      } else {\n        this.$confirm('是否删除公司\"' + this.selectCompanyNode.companyName + '\"', '提示', {\n          confirmButtonText: '确定',\n          cancelButtonText: '取消',\n          type: 'warning'\n        }).then(() => {\n          byDelete('/company/' + this.selectCompanyNode.companyId, null).then(response => {\n            if (response.status === 0) {\n              this.$refs.companyTree.remove(this.selectCompanyNode)\n              this.selectCompanyNode = null\n              this.$message({\n                message: '公司删除成功',\n                type: 'success',\n                duration: 3000\n              })\n            } else {\n              this.$message({\n                message: '删除失败，请稍后重试',\n                type: 'warning',\n                duration: 3000\n              })\n            }\n          })\n        }).catch(() => {\n\n        })\n      }\n    },\n    addCompany: function(type) { // 增加、修改公司\n      this.addCompanyType = type\n      if (type === 1) {\n        if (this.selectCompanyNode === null) {\n          this.$message({\n            message: '请选择需要修改的公司',\n            type: 'warning',\n            duration: 3000\n          })\n          return\n        }\n      }\n      this.showCompany = true\n    },\n    submitCompany: function() {\n      var that = this\n      this.$refs.addCompanyForm.validate((valid) => {\n        if (valid) {\n          var company = {\n            companyId: null,\n            pid: null,\n            companyName: this.addCompanyForm.name\n          }\n          if (this.addCompanyType === 0) {\n            if (this.selectCompanyNode !== null) {\n              company.pid = this.selectCompanyNode.companyId\n            } else {\n              company.pid = this.companyId\n            }\n            company.master = this.addCompanyForm.principal\n            company.phone = this.addCompanyForm.mobile\n            post('/company', company).then(response => {\n              if (response.status === 0) {\n                this.$message({\n                  message: '公司添加成功',\n                  type: 'success',\n                  duration: 3000\n                })\n                this.$refs.companyTree.append(response.data, response.data.pid)\n              } else {\n                this.$message({\n                  message: response.msg,\n                  type: 'warning',\n                  duration: 3000\n                })\n              }\n              that.cancelCompany()\n            })\n          } else {\n            company.companyId = this.selectCompanyNode.companyId\n            company.headCpId = this.companyId\n            put('/company', company).then(response => {\n              if (response.status === 0) {\n                this.companyData = response.data\n                this.$message({\n                  message: '公司修改成功',\n                  type: 'success',\n                  duration: 3000\n                })\n              } else {\n                this.$message({\n                  message: response.msg,\n                  type: 'warning',\n                  duration: 3000\n                })\n              }\n              that.cancelCompany()\n            })\n          }\n        } else {\n          return\n        }\n      })\n    },\n    cancelCompany: function() {\n      this.showCompany = false\n      this.$refs.addCompanyForm.resetFields()\n    },\n    getDepartmentInfo: function(companyId) { // 获取部门信息\n      get('/dept/list/' + companyId, null).then(response => {\n        if (response.status === 0) {\n          this.departmentData = response.data\n        }\n      })\n    },\n    departmentClick: function(node) { // 部门树列表点击\n      this.selectDepartmentNode = node\n      this.addDepartmentForm.oldName = node.name\n      this.getUserInfoByDepartment(node.id, 1)\n    },\n    addDepartment: function(type) {\n      if (this.selectCompanyNode === null) {\n        this.$message({\n          message: '请选择需要添加部门的公司',\n          type: 'warning',\n          duration: 3000\n        })\n      } else {\n        this.addDepartmentType = type\n        this.showDepartment = true\n      }\n    },\n    deleteDepartment: function() {\n      if (this.selectDepartmentNode === null) {\n        this.$message({\n          message: '请选择需要删除的部门',\n          type: 'warning',\n          duration: 3000\n        })\n      } else {\n        this.$confirm('是否删除部门\"' + this.selectDepartmentNode.name + '\"', '提示', {\n          confirmButtonText: '确定',\n          cancelButtonText: '取消',\n          type: 'warning'\n        }).then(() => {\n          byDelete('/dept/' + this.selectDepartmentNode.id, null).then(response => {\n            if (response.status === 0) {\n              this.$refs.departmentTree.remove(this.selectDepartmentNode.id)\n              this.selectDepartmentNode = null\n              this.$message({\n                message: '部门删除成功',\n                type: 'success',\n                duration: 3000\n              })\n            } else {\n              this.$message({\n                message: response.msg,\n                type: 'warning',\n                duration: 3000\n              })\n            }\n          })\n        }).catch(() => {\n\n        })\n      }\n    },\n    getUserInfoByDepartment: function(departmentId, number) { // 根据部门id获取用户列表\n      this.userLoading = true\n      this.userSearchType = 1\n      get('/user/page/dp' + departmentId, { size: this.listQuery.limit, page: number - 1 }).then(response => {\n        this.userLoading = false\n        if (response.status === 0) {\n          this.total = response.data.totalElements\n          this.userData = response.data.content\n        }\n      })\n    },\n    submitDepartment: function() {\n      var that = this\n      this.$refs.addDepartmentForm.validate((valid) => {\n        if (valid) {\n          var department = {\n            id: null,\n            cpid: null,\n            name: this.addDepartmentForm.name\n          }\n          if (this.addDepartmentType === 0) {\n            department.cpid = this.selectCompanyNode.companyId\n            post('/dept', department).then(response => {\n              if (response.status === 0) {\n                this.$message({\n                  message: '部门添加成功',\n                  type: 'success',\n                  duration: 3000\n                })\n                this.$refs.departmentTree.append(response.data, 0)\n              } else {\n                this.$message({\n                  message: '添加失败，请稍后重试',\n                  type: 'warning',\n                  duration: 3000\n                })\n              }\n              that.cancelDepartment()\n            })\n          } else {\n            put('/dept/' + this.selectDepartmentNode.id + '/' + this.selectCompanyNode.companyId + '/' + this.addDepartmentForm.name, null).then(response => {\n              if (response.status === 0) {\n                this.departmentData = response.data\n                this.$message({\n                  message: '部门修改成功',\n                  type: 'success',\n                  duration: 3000\n                })\n              } else {\n                this.$message({\n                  message: '添加失败，请稍后重试',\n                  type: 'warning',\n                  duration: 3000\n                })\n              }\n              that.cancelDepartment()\n            })\n          }\n        } else {\n          return\n        }\n      })\n    },\n    cancelDepartment: function() {\n      this.showDepartment = false\n      this.$refs.addDepartmentForm.resetFields()\n    },\n    addUser: function(type) {\n      if (this.selectDepartmentNode === null) {\n        this.$message({\n          message: '请选择需要添加用户的部门',\n          type: 'warning',\n          duration: 3000\n        })\n      } else {\n        this.addUserInfo.cpid = this.selectCompanyNode.companyId\n        this.addUserInfo.deptId = this.selectDepartmentNode.id\n        this.addUserInfo.type = type\n        this.addUserType = type\n        this.showUser = true\n      }\n    },\n    deleteUser: function() {\n      var users = this.$refs.userTable.selection\n      if (users.length > 0) {\n        this.$confirm('确定删除勾选的用户吗？', '提示', {\n          confirmButtonText: '确定',\n          cancelButtonText: '取消',\n          type: 'warning'\n        }).then(() => {\n          var delList = []\n          users.forEach(item => {\n            delList.push(item.userId)\n          })\n          byDelete('/user/ids', delList).then(response => {\n            if (response.status === 0) {\n              this.$message({\n                message: '用户删除成功',\n                type: 'success',\n                duration: 3000\n              })\n            } else {\n              this.$message({\n                message: response.msg,\n                type: 'warning',\n                duration: 3000\n              })\n            }\n          })\n        })\n      } else {\n        this.$message({\n          message: '请勾选需要删除的用户',\n          type: 'warning',\n          duration: 3000\n        })\n      }\n    },\n    updateUser: function(user) {\n      this.addUserInfo.cpid = user.row.cpid\n      this.addUserInfo.deptId = user.row.deptId\n      this.addUserInfo.userId = user.row.userId\n      this.addUserInfo.cusName = user.row.cusName\n      this.addUserInfo.phone = user.row.phone\n      this.addUserInfo.postName = user.row.postName\n      this.addUserInfo.cusPic = user.row.cusPic\n      this.addUserInfo.type = 1\n      this.addUserType = 1\n      this.showUser = true\n    },\n    handleDD: function(data) { // 角色下拉菜单\n      this.userRoleForm.showName = data.showName\n      this.userRoleForm.roleId = data.id\n    },\n    cancelUserRole: function() { // 修改角色取消\n      this.userRoleForm.id = 0\n      this.userRoleForm.index = -1\n      this.userRoleForm.showName = ''\n      this.userRoleForm.roleId = 0\n      this.showUserRole = false\n    },\n    updateUserRole: function(user) {\n      this.userRoleForm.id = user.row.userId\n      this.userRoleForm.index = user.$index\n      this.userRoleForm.showName = user.row.roleList.length > 0 ? user.row.roleList[0].showName : ''\n      this.showUserRole = true\n    },\n    submitUserRole: function() {\n      if (this.userRoleForm.roleId <= 0) {\n        this.$message({\n          message: '请选择角色',\n          type: 'warning',\n          duration: 3000\n        })\n      } else {\n        put('/user/' + this.userRoleForm.id + '/' + this.userRoleForm.roleId, null).then(response => {\n          if (response.status === 0) {\n            if (this.userData[this.userRoleForm.index].roleList.length > 0) {\n              this.userData[this.userRoleForm.index].roleList[0].showName = this.userRoleForm.showName\n            } else {\n              this.userData[this.userRoleForm.index].roleList.push({\n                id: this.userRoleForm.roleId,\n                showName: this.userRoleForm.showName\n              })\n            }\n            this.$message({\n              message: '用户角色修改成功',\n              type: 'success',\n              duration: 3000\n            })\n          } else {\n            this.$message({\n              message: response.msg,\n              type: 'warning',\n              duration: 3000\n            })\n          }\n          this.showUserRole = false\n        })\n      }\n    },\n    deleteUserById: function(user) {\n      this.$confirm('确定删除用户\"' + user.row.cusName + '\"吗？', '提示', {\n        confirmButtonText: '确定',\n        cancelButtonText: '取消',\n        type: 'warning'\n      }).then(() => {\n        byDelete('/user/' + user.row.userId, null).then(response => {\n          if (response.status === 0) {\n            this.$message({\n              message: '用户\"' + user.row.cusName + '\"删除成功',\n              type: 'success',\n              duration: 3000\n            })\n            this.userData.splice(user.$index)\n          } else {\n            this.$message({\n              message: response.msg,\n              type: 'warning',\n              duration: 3000\n            })\n          }\n        })\n      })\n    },\n    resetPassword: function(user) {\n      this.$confirm('确定重置用户\"' + user.row.cusName + '\"的密码吗？', '提示', {\n        confirmButtonText: '确定',\n        cancelButtonText: '取消',\n        type: 'warning'\n      }).then(() => {\n        put('/user/reset/' + user.row.userId, null).then(response => {\n          if (response.status === 0) {\n            this.$message({\n              message: '用户\"' + user.row.cusName + '\"密码重置成功',\n              type: 'success',\n              duration: 3000\n            })\n          } else {\n            this.$message({\n              message: response.msg,\n              type: 'warning',\n              duration: 3000\n            })\n          }\n        })\n      })\n    },\n    submitUser: function() {\n      this.showUser = false\n      if (this.userSearchType === 0) { // 公司\n        this.getUserInfoByCompany(this.selectCompanyId, this.listQuery.page)\n      } else {\n        this.getUserInfoByDepartment(this.selectDepartmentNode.id, this.listQuery.page)\n      }\n    },\n    getUserInfoByCompany: function(companyId, number) { // 根据公司id获取用户列表\n      this.userLoading = true\n      this.userSearchType = 0\n      get('/user/page/cp' + companyId, { size: this.listQuery.limit, page: number - 1 }).then(response => {\n        this.userLoading = false\n        if (response.status === 0) {\n          this.total = response.data.totalElements\n          this.userData = response.data.content\n        }\n      })\n    },\n    pageChange: function(page) {\n      if (this.userSearchType === 0) { // 公司\n        this.getUserInfoByCompany(this.selectCompanyId, page[0].page)\n      } else {\n        this.getUserInfoByDepartment(this.selectDepartmentNode.id, page[0].page)\n      }\n    },\n    getRoleInfo: function(companyId) { // 获取角色列表\n      this.roleLoading = true\n      get('/role/list/' + companyId, null).then(response => {\n        this.roleLoading = false\n        if (response.status === 0) {\n          this.roleData = response.data\n        }\n      })\n    },\n    addRole() {\n      if (this.selectCompanyNode === null) {\n        this.$message({\n          message: '请选择需要添加角色的公司',\n          type: 'warning',\n          duration: 3000\n        })\n      } else {\n        this.addRoleType = 0\n        this.addRoleId = 0\n        this.addRoleName = ''\n        this.showRole = true\n      }\n    },\n    updateRole(data) {\n      this.addRoleType = 1\n      this.addRoleId = data.id\n      this.addRoleName = data.showName\n      this.showRole = true\n    },\n    deleteRole(data) {\n      this.$confirm('确定删除角色\"' + data.showName + '\"吗？', '提示', {\n        confirmButtonText: '确定',\n        cancelButtonText: '取消',\n        type: 'warning'\n      }).then(() => {\n        post('/role/del/' + data.id, null).then(response => {\n          if (response.status === 0) {\n            this.getRoleInfo(this.selectCompanyId)\n            this.$message({\n              message: '角色\"' + data.showName + '\"删除成功',\n              type: 'success',\n              duration: 3000\n            })\n          } else {\n            this.$message({\n              message: response.msg,\n              type: 'warning',\n              duration: 3000\n            })\n          }\n        })\n      })\n    },\n    submitRole() {\n      this.showRole = false\n      this.getRoleInfo(this.selectCompanyId)\n    }\n  }\n}\n",null]}